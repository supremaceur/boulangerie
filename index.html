<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Saveurs Pasteur</title>
  <link rel="icon" href="https://iili.io/KnQjBa4.md.webp" type="image/webp">
  <link href="./dist/output.css" rel="stylesheet">
  <link href="./styles.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="bg-stone-100">
  <div id="app" class="max-w-7xl mx-auto">
    <!-- Spinner global -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-amber-600"></div>
    </div>

    <!-- Page d'accueil / redirection -->
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-2xl shadow-lg p-8 text-center" style="background-color: #F9F4EA;">
        <img src="https://iili.io/KnQjBa4.md.webp" alt="Logo Boulangerie" class="mx-auto h-48 w-auto">
        <h1 class="font-brand text-4xl text-stone-800 mt-4">Saveurs Pasteur</h1>
        <p class="text-stone-500 mt-2">Commandez vos formules en ligne</p>
        
        <div class="mt-8">
          <p id="status-message" class="text-stone-600 mb-4">Vérification de votre session...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Script de redirection automatique
    document.addEventListener('DOMContentLoaded', async () => {
      const SUPABASE_URL = 'https://zliusqwhpqzszjetvrpx.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsaXVzcXdocHF6c3pqZXR2cnB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNjE2MzgsImV4cCI6MjA3MjczNzYzOH0.Zb3InrWND0YpIUNHSHKDdPUxQzgihQOB2491VRb994E';
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });

      const statusMessage = document.getElementById('status-message');
      const loader = document.getElementById('loader');

      try {
        // Vérifier la session actuelle
        const { data: { session } } = await supabaseClient.auth.getSession();
        
        if (!session?.user) {
          // Pas de session active, rediriger vers login
          statusMessage.textContent = 'Redirection vers la page de connexion...';
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 1000);
          return;
        }

        // Session active, vérifier le rôle de l'utilisateur
        statusMessage.textContent = 'Vérification de vos autorisations...';
        
        try {
          let { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('is_admin, first_name, last_name')
            .eq('id', session.user.id)
            .single();

          // Si le profil n'existe pas, le créer
          if (error && error.code === 'PGRST116') {
            console.log('Profile not found, creating profile for user:', session.user.id);
            statusMessage.textContent = 'Création de votre profil...';
            
            // Extraire le nom et prénom depuis les métadonnées Google
            let firstName = '';
            let lastName = '';
            
            if (session.user.user_metadata) {
              // Vérifier d'abord les champs directs
              firstName = session.user.user_metadata.first_name || session.user.user_metadata.given_name || '';
              lastName = session.user.user_metadata.last_name || session.user.user_metadata.family_name || '';
              
              // Si pas de prénom/nom, essayer de diviser le full_name
              if (!firstName && !lastName && session.user.user_metadata.full_name) {
                const nameParts = session.user.user_metadata.full_name.split(' ');
                firstName = nameParts[0] || '';
                lastName = nameParts.slice(1).join(' ') || '';
              }
              
              // Si toujours vide, utiliser le name de Google
              if (!firstName && !lastName && session.user.user_metadata.name) {
                const nameParts = session.user.user_metadata.name.split(' ');
                firstName = nameParts[0] || '';
                lastName = nameParts.slice(1).join(' ') || '';
              }
            }

            console.log('Creating profile with:', { firstName, lastName, userMetadata: session.user.user_metadata });

            const { error: insertError } = await supabaseClient
              .from('profiles')
              .insert({
                id: session.user.id,
                first_name: firstName,
                last_name: lastName,
                is_admin: false
              });

            if (insertError) {
              console.error('Error creating profile:', insertError);
              statusMessage.textContent = 'Erreur de profil, redirection vers l\'espace client...';
              setTimeout(() => {
                window.location.href = 'customer.html';
              }, 1000);
              return;
            }

            // Récupérer le nouveau profil
            const { data: newProfile } = await supabaseClient
              .from('profiles')
              .select('is_admin, first_name, last_name')
              .eq('id', session.user.id)
              .single();
            
            profile = newProfile;
          } else if (error) {
            console.error('Error fetching profile:', error);
            statusMessage.textContent = 'Erreur de profil, redirection vers l\'espace client...';
            setTimeout(() => {
              window.location.href = 'customer.html';
            }, 1000);
            return;
          }

          // Redirection selon is_admin
          if (profile?.is_admin === true) {
            statusMessage.textContent = `Bonjour ${profile.first_name || ''}, redirection vers l'administration...`;
            setTimeout(() => {
              window.location.href = 'admin.html';
            }, 1500);
          } else {
            statusMessage.textContent = `Bonjour ${profile?.first_name || ''}, redirection vers l'espace client...`;
            setTimeout(() => {
              window.location.href = 'customer.html';
            }, 1500);
          }

        } catch (profileError) {
          console.error('Profile fetch error:', profileError);
          statusMessage.textContent = 'Redirection vers l\'espace client...';
          setTimeout(() => {
            window.location.href = 'customer.html';
          }, 1000);
        }

      } catch (error) {
        console.error('Session check error:', error);
        statusMessage.textContent = 'Erreur de connexion, redirection...';
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1000);
      }
    });
  </script>
</body>
</html>